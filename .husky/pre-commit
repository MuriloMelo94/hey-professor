#!/bin/sh

# IntroduÃ§Ã£o criativa no pre-commit com barra giratoria e emoji
echo ""
echo "ðŸš€ Preparando etapa de pre-commit ..."

# Barra giratÃ³ria
spin='-\|/'
i=0
counter=0
while [ $counter -lt 20 ]; do
  printf "\r${spin:$i:1} Executando verificaÃ§Ãµes prÃ©-commit..."
  i=$(( (i+1) % 4 ))
  counter=$(( counter + 1 ))
  sleep 0.1
done

# Finaliza a barra giratÃ³ria
printf "\râœ”ï¸  VerificaÃ§Ãµes iniciadas com sucesso! ðŸ› ï¸\n\n"

# Rodar comandos de otimizaÃ§Ã£o e limpar cache
echo -e "\033[47;30m INFO \033[0m Rodando otimizaÃ§Ã£o e limpeza de cache... âš™ï¸"
php artisan optimize:clear
if [ $? -ne 0 ]; then
    echo -e "\033[47;30m ERROR \033[0m Opa! Algo deu errado com a otimizaÃ§Ã£o. Verifique e tente novamente! âŒ"
    exit 1
fi

php artisan config:clear
if [ $? -ne 0 ]; then
    echo -e "\033[47;30m ERROR \033[0m Opa! Algo deu errado ao limpar a configuraÃ§Ã£o. Verifique e tente novamente! âŒ"
    exit 1
fi

# Rodar o phpstan
echo ""
echo -e "\033[47;30m INFO \033[0m Inicializando anÃ¡lise estÃ¡tica... ðŸ›¸"
echo ""
./vendor/bin/phpstan
if [ $? -ne 0 ]; then
    echo -e "\033[47;30m ERROR \033[0m Opa! Deu ruim aqui com PHPSTAN. Arrume antes de continuar... ðŸ˜‰"
    echo ""
    exit 1;
fi;

# Roda os testes
echo -e "\033[47;30m INFO \033[0m Inicializando testes paralelos... ðŸ“š"
echo ""
php artisan test --parallel
if [ $? -ne 0 ]; then
    echo -e "\033[47;30m ERROR \033[0m Opa! Deu ruim aqui com os TESTES. Arrume antes de continuar... ðŸ˜‰"
    echo ""
    exit 1;
fi;

# Formatar cada arquivo alterado usando o Laravel Pint
echo -e "\033[47;30m INFO \033[0m Formatando arquivos modificados com Laravel Pint... ðŸ–‹ï¸"
echo ""
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep ".php\{0,1\}$") || true
for FILE in $STAGED_FILES
do
    ./vendor/bin/pint "${FILE}" > /dev/null >&1;
    git add "${FILE}";
done;

echo "âœ… Pre-commit finalizado com sucesso! Tudo pronto para seguir. ðŸ”’"
echo ""

exit 0;
